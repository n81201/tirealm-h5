<script>
    /* === 6.0版：Supabase API 集成 (Read + Write + RLS) === */

// ======================== 配置区 (已填充你的密钥) =========================
    // 1. 你的 Supabase 项目 URL
    const SUPABASE_URL = 'https://hehevgyochjcpovhfhhc.supabase.co'; 
    // 2. 你的 Anon Key
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhlaGV2Z3lvY2hqY3BvdmhmaGhjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwNzk1OTAsImV4cCI6MjA3OTY1NTU5MH0.9ize83B3jZo0iLC7-OvknDYWVMb6GqW_YN5gcFiLguU'; 
    // ======================================================
    
    const PRODUCTS_TABLE = 'products';
    const SERVICES_TABLE = 'service_logs';

    // --- 全局变量用于存储已验证的产品编码 ---
    let validatedCode = null;

    // =====================================================
    // A. 查询/防伪/读取 逻辑 (queryData)
    // =====================================================
    async function queryData() {
        const codeInput = document.getElementById('productCode');
        let inputVal = codeInput.value.trim().toUpperCase();
        const resultArea = document.getElementById('resultArea');
        const inputFormArea = document.getElementById('inputFormArea');
        const queryBtn = document.querySelector('.search-box .btn');
        
        validatedCode = null; // 重置
        resultArea.style.display = 'none';
        inputFormArea.style.display = 'none';

        if(!inputVal) { alert("请输入编码"); return; }
        
        queryBtn.innerText = "正在验证...";
        queryBtn.disabled = true;

        try {
            // 1. 构造查询 URL：查询 code 等于输入值的记录
            // select=* 表示查询所有字段；eq 是过滤操作符
            const url = `${SUPABASE_URL}/rest/v1/${PRODUCTS_TABLE}?code=eq.${inputVal}&select=*`;

            const response = await fetch(url, {
                method: 'GET',
                headers: { 
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                }
            });
            const records = await response.json(); // Supabase API 返回 JSON 数组

            if (records && records.length > 0) {
                const record = records[0]; // 获取匹配的记录
                
                // 验证成功，存储产品编码 (用于后续写入)
                validatedCode = record.code.toUpperCase();
                
                // 填充并显示查询结果
                document.getElementById('pCode').innerText = validatedCode;
                document.getElementById('pName').innerText = record.name || 'TiRealm 产品'; 
                document.getElementById('pBatch').innerText = record.batch || '-';
                
                const status = record.status || 'in_stock';
                const statusBadge = document.getElementById('pStatus');
                statusBadge.innerText = status === 'serviced' ? '已完成施工' : '在库待激活';
                statusBadge.className = "status-tag";
                
                // 状态判断
                if (status === 'serviced') {
                    statusBadge.classList.add("status-used");
                    inputFormArea.style.display = 'none'; 
                    // 假设你可以在 products 表中 Lookup 关联的服务记录信息
                    // 暂时显示通用信息，因为我们没有复杂查询关联表
                    document.getElementById('cTech').innerText = '已登记 (查询后台)';
                    document.getElementById('cClient').innerText = '已登记 (查询后台)';
                    document.getElementById('cDate').innerText = record.updated_at ? new Date(record.updated_at).toLocaleDateString() : '-';
                    
                } else {
                    statusBadge.classList.add("status-ok");
                    // 验真成功且未施工，显示录入表单
                    inputFormArea.style.display = 'block'; 
                    document.getElementById('cTech').innerText = '暂未登记';
                    document.getElementById('cClient').innerText = '暂未登记';
                    document.getElementById('cDate').innerText = '-';
                }
                
                resultArea.style.display = 'block';

            } else {
                // 验证失败，防伪功能生效 (RLS在这里起了作用，如果编码不存在，返回空数组)
                alert("查无此码，非正品或编码错误，请核对！");
                resultArea.style.display = 'none';
                validatedCode = null;
            }
            
        } catch (error) {
            console.error("查询失败:", error);
            alert("数据库连接失败或网络错误！");
        } finally {
            queryBtn.innerText = "查询档案";
            queryBtn.disabled = false;
        }
    }

    // =====================================================
    // B. 施工录入/写入 逻辑 (submitService)
    // =====================================================
    document.getElementById('serviceForm').addEventListener('submit', async function(e) {
        e.preventDefault(); 
        
        if (!validatedCode) {
            alert("请先验证产品编码！");
            return;
        }

        const techInput = document.getElementById('techInput');
        const clientInput = document.getElementById('clientInput');
        const serviceBtn = document.getElementById('serviceBtn');
        const writeMsg = document.getElementById('writeMsg');
        
        serviceBtn.innerText = "上传中...";
        serviceBtn.disabled = true;
        
        // 1. 构建写入 service_logs 表的数据对象
        const data = {
            product_code_ref: validatedCode, // 写入外键
            client_info: clientInput.value.trim(),
            technician_name: techInput.value.trim()
        };

        try {
            // 2. 写入 service_logs 表
            // RLS 此时会检查 Anon Key是否有 INSERT 权限
            const response = await fetch(`${SUPABASE_URL}/rest/v1/${SERVICES_TABLE}`, {
                method: 'POST',
                headers: { 
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=representation' // 确保返回数据
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                const errorBody = await response.json();
                // 如果 RLS 没有配置好，这里会报错：Reason: RLS policy forbids insertion
                throw new Error(errorBody.message || `Supabase Write Error: ${response.status}`);
            }

            // 3. 写入成功后：触发器已自动更新 products 表状态！
            
            // 清除表单，通知店员
            serviceBtn.style.display = 'none';
            writeMsg.style.display = 'block'; 
            
            // 自动刷新查询结果，让店员看到状态变更为“已施工”
            setTimeout(() => {
                queryData(); // 重新查询，利用触发器更新后的状态
                document.getElementById('serviceForm').reset();
            }, 1500);

        } catch (err) {
            console.error("登记失败:", err);
            alert(`登记失败: ${err.message}. 请检查 RLS 或网络配置。`);
            serviceBtn.innerText = "重试";
            serviceBtn.disabled = false;
        }
    });

    // C. 页面初始化逻辑 (保持不变)
    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        const codeFromUrl = urlParams.get('code');
        
        if(codeFromUrl) {
            document.getElementById('productCode').value = codeFromUrl;
            queryData();
        }
    }
</script>
