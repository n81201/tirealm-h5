<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TiRealmÂ® TICS - æ•°å­—åŒ–ç®¡ç†ç³»ç»Ÿ</title>
    <!-- æ ¸å¿ƒåº“å¼•å…¥ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', -apple-system, "SF Pro Display", "PingFang SC", sans-serif;
            background: #f1f5f9;
            background-image: 
                radial-gradient(at 0% 0%, rgba(8, 145, 178, 0.05) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(30, 41, 59, 0.05) 0px, transparent 50%);
            color: #1e293b;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        /* é»„é‡‘å®½åº¦å±…ä¸­å®¹å™¨ */
        .app-viewport {
            width: 100%;
            max-width: 480px; 
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 0 24px;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 20px 40px -15px rgba(15, 23, 42, 0.08);
            width: 100%;
            border-radius: 2.5rem;
        }

        .baseline-card {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            width: 100%;
        }

        .btn-primary {
            background-color: #0f172a;
            color: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-primary:active { transform: scale(0.97); opacity: 0.9; }
        .btn-primary:disabled { background-color: #94a3b8; cursor: not-allowed; }

        .btn-accent {
            background-color: #0891b2;
            color: white;
            box-shadow: 0 4px 12px rgba(8, 145, 178, 0.2);
        }

        /* çŠ¶æ€æ ‡ç­¾ */
        .status-tag {
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }
        .status-in_stock { background: #ecfdf5; color: #059669; }
        .status-serviced { background: #eff6ff; color: #2563eb; }

        .bg-line {
            position: fixed;
            top: 40%;
            left: 0;
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(8, 145, 178, 0.1), transparent);
            z-index: -1;
        }

        /* é¡µé¢åˆ‡æ¢åŠ¨ç”» */
        .page { display: none; opacity: 0; transform: translateY(10px); width: 100%; transition: all 0.4s ease; }
        .page.active { display: flex; flex-direction: column; align-items: center; opacity: 1; transform: translateY(0); }

        /* æ‰«ç æ¨¡æ€æ¡† */
        #scannerModal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            z-index: 1000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        #reader {
            width: 100%;
            max-width: 350px;
            border-radius: 1rem;
            overflow: hidden;
            border: 2px solid #0891b2;
        }

        /* è¾“å…¥æ¡†ç»Ÿä¸€æ ·å¼ */
        .input-std {
            width: 100%;
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            outline: none;
            transition: all 0.2s;
        }
        .input-std:focus {
            border-color: #0891b2;
            background-color: #fff;
            box-shadow: 0 0 0 3px rgba(8, 145, 178, 0.1);
        }
    </style>
</head>
<body>

    <div class="bg-line"></div>

    <div class="app-viewport">
        
        <!-- é¦–é¡µ (Home Page) -->
        <div id="home-page" class="page active px-6">
            <!-- é¡¶éƒ¨å“ç‰ŒåŒº -->
            <header class="w-full py-16 text-center">
                <div class="inline-flex items-center justify-center px-3 py-1 mb-4 rounded-full bg-slate-200/50 border border-slate-300/30 mx-auto">
                    <span class="text-[9px] tracking-[0.3em] font-bold text-slate-500 uppercase">TICS System</span>
                </div>
                <h1 class="text-4xl font-bold tracking-[0.25em] text-slate-900 pl-[0.25em]">TiRealm<span class="text-lg font-bold align-top ml-1">Â®</span></h1>
                <p class="text-[10px] text-slate-400 mt-4 tracking-[0.4em] uppercase font-medium pl-[0.4em]">Digital Air Management</p>
            </header>

            <main class="w-full space-y-8">
                
                <!-- æ¶ˆæ¯æç¤º -->
                <div id="messageBox" class="hidden w-full p-4 rounded-2xl text-center text-xs font-bold mb-4 transition-all"></div>

                <!-- 1. æŸ¥è¯¢æ¨¡å— -->
                <section class="glass-card rounded-[2.5rem] p-10 text-center relative overflow-hidden">
                    <div class="mb-10">
                        <h2 class="text-lg font-bold text-slate-800 tracking-tight">äº§å“æ¡£æ¡ˆæŸ¥è¯¢</h2>
                        <p class="text-[11px] text-slate-400 mt-2 font-medium">è¯·è¾“å…¥æˆ–æ‰«æäº§å“å”¯ä¸€è¯†åˆ«ç¼–ç </p>
                    </div>

                    <div class="space-y-4">
                        <input type="text" id="productCode" placeholder="TI-XXXXXX" 
                               class="w-full bg-slate-50 border border-slate-200 rounded-2xl py-5 px-6 text-center text-xl font-mono font-bold tracking-[0.1em] text-slate-800 placeholder:text-slate-200 focus:ring-2 focus:ring-cyan-500/20 focus:border-cyan-500 transition-all outline-none">
                        
                        <div class="flex gap-3">
                            <button onclick="queryData()" class="btn-primary flex-[2] text-white py-5 rounded-2xl font-bold text-sm tracking-widest action-btn">æŸ¥è¯¢æ¡£æ¡ˆ</button>
                            <button onclick="startScanner()" class="btn-accent w-20 text-white py-5 rounded-2xl font-bold text-sm flex items-center justify-center active:scale-95 transition-all action-btn">
                                <span class="text-2xl">ğŸ“·</span>
                            </button>
                        </div>
                    </div>
                </section>

                <!-- 2. ç»“æœå±•ç¤ºåŒºåŸŸ (éšè—) -->
                <section id="resultArea" class="hidden glass-card rounded-[2.5rem] p-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
                    <div class="flex items-center justify-between mb-6">
                        <span class="text-[10px] font-bold tracking-widest text-cyan-600 uppercase">Archive Data</span>
                        <div id="pStatusContainer">
                            <span id="pStatus" class="status-tag">---</span>
                        </div>
                    </div>

                    <!-- äº§å“ä¿¡æ¯ -->
                    <div class="space-y-4 border-b border-slate-100 pb-6 mb-6">
                        <div class="flex justify-between">
                            <span class="text-xs text-slate-400">äº§å“ç¼–ç </span>
                            <span id="pCode" class="text-xs font-mono font-bold text-slate-700">---</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-xs text-slate-400">äº§å“åç§°</span>
                            <span id="pName" class="text-xs font-bold text-slate-700">---</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-xs text-slate-400">ç”Ÿäº§æ‰¹æ¬¡</span>
                            <span id="pBatch" class="text-xs font-bold text-slate-700">---</span>
                        </div>
                    </div>

                    <!-- æ–½å·¥ç™»è®°è¡¨å• (å¾…æ–½å·¥) -->
                    <div id="serviceFormArea" class="hidden space-y-4">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                            <h3 class="text-xs font-bold text-slate-700 uppercase tracking-wider">æ–½å·¥ç™»è®°</h3>
                        </div>
                        
                        <div class="space-y-3">
                            <input type="text" id="techName" placeholder="* æ–½å·¥æŠ€å¸ˆ/å•ä½åç§°" class="input-std">
                            <input type="text" id="clientName" placeholder="* å®¢æˆ·å§“å" class="input-std">
                            <input type="text" id="clientPhone" placeholder="* å®¢æˆ·ç”µè¯" class="input-std">
                            <input type="text" id="serviceAddress" placeholder="* æ–½å·¥åœ°å€" class="input-std">
                            <input type="text" id="serviceArea" placeholder="* æ–½å·¥éƒ¨ä½ (å¦‚:è½¦å†…å†…é¥°)" class="input-std">
                        </div>
                        <button id="registerBtn" onclick="registerService()" class="w-full btn-accent py-4 rounded-xl font-bold text-xs tracking-widest uppercase mt-4 shadow-lg shadow-cyan-900/20">
                            ç¡®è®¤ç™»è®°å¹¶é”å®šæ¡£æ¡ˆ
                        </button>
                    </div>

                    <!-- æ–½å·¥å†å²è®°å½• (å·²æ–½å·¥) -->
                    <div id="serviceLogDisplay" class="hidden space-y-4">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="w-1.5 h-1.5 rounded-full bg-blue-500"></span>
                            <h3 class="text-xs font-bold text-slate-700 uppercase tracking-wider">æœ€æ–°æ–½å·¥è®°å½•</h3>
                        </div>
                        
                        <div class="bg-slate-50 rounded-2xl p-5 space-y-3 border border-slate-100">
                            <div class="flex justify-between items-center">
                                <span class="text-[10px] text-slate-400">æ–½å·¥å•ä½</span>
                                <span id="logTechName" class="text-xs font-bold text-slate-700">---</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-[10px] text-slate-400">å®Œæˆæ—¶é—´</span>
                                <span id="logDate" class="text-xs font-bold text-slate-700">---</span>
                            </div>
                            <div class="w-full h-[1px] bg-slate-200/50 my-2"></div>
                            <div class="flex justify-between items-center">
                                <span class="text-[10px] text-slate-400">å®¢æˆ·å§“å</span>
                                <span id="logClientName" class="text-xs font-bold text-slate-700">---</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-[10px] text-slate-400">è”ç³»æ–¹å¼</span>
                                <span id="logClientPhone" class="text-xs font-bold text-slate-700">---</span>
                            </div>
                            <div class="flex justify-between items-start">
                                <span class="text-[10px] text-slate-400 whitespace-nowrap">åœ°å€</span>
                                <span id="logServiceAddress" class="text-xs font-bold text-slate-700 text-right break-words pl-4">---</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-[10px] text-slate-400">éƒ¨ä½</span>
                                <span id="logServiceArea" class="text-xs font-bold text-slate-700">---</span>
                            </div>
                        </div>
                        
                        <div class="text-center pt-2">
                            <span class="text-[9px] font-bold text-cyan-600 bg-cyan-50 border border-cyan-100 px-3 py-1 rounded-full uppercase tracking-tighter">
                                Secure Locked Archive
                            </span>
                        </div>
                    </div>
                </section>

                <!-- 3. AirBaseline æœåŠ¡å±•ç¤ºå— -->
                <section class="baseline-card rounded-[2.5rem] p-9 text-white shadow-2xl relative overflow-hidden group">
                    <div class="absolute right-0 top-0 w-32 h-32 bg-cyan-500/10 rounded-full blur-[60px]"></div>
                    
                    <div class="relative z-10">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center gap-2">
                                <div class="w-1.5 h-1.5 rounded-full bg-cyan-400"></div>
                                <span class="text-[11px] font-bold tracking-[0.2em] text-cyan-400 uppercase">AirBaseline</span>
                            </div>
                            <span class="text-[9px] opacity-40 font-mono tracking-tighter italic">V.01 DATA-TRUST</span>
                        </div>
                        
                        <h3 class="text-2xl font-bold mb-3 tracking-tight">ç©ºæ°”å¥åº·åŸºçº¿æ¡£æ¡ˆ</h3>
                        <p class="text-xs text-slate-400 leading-relaxed font-light mb-8">
                            æˆ‘ä»¬ä¸åªæä¾›æ²»ç†ã€‚AirBaseline ä¸ºç©ºé—´å»ºç«‹å…¨ç”Ÿå‘½å‘¨æœŸçš„ç©ºæ°”å¥åº·æ—¶é—´è½´è®°å½•ï¼Œå®ç°æ•°æ®çš„å¯è¿½æº¯ä¸é•¿æœŸæ‰˜ç®¡ã€‚
                        </p>

                        <div class="flex items-center gap-4">
                            <div class="flex-1 h-[1px] bg-white/10"></div>
                            <button onclick="showPage('baseline-page')" class="text-[10px] font-bold tracking-widest text-cyan-400 hover:text-cyan-300 transition-colors uppercase flex items-center gap-1 cursor-pointer">
                                è¿›å…¥åŸºçº¿æ¡£æ¡ˆ <span>â†’</span>
                            </button>
                        </div>
                    </div>
                </section>

                <footer class="text-center py-12">
                    <p class="text-[10px] text-slate-400 tracking-[0.25em] font-semibold uppercase pl-[0.25em]">Powered by TiRealmÂ® TICS</p>
                </footer>
            </main>
        </div>

        <!-- åŸºçº¿è¯¦æƒ…å ä½é¡µ -->
        <div id="baseline-page" class="page px-6 py-12">
            <button onclick="showPage('home-page')" class="text-xs text-slate-500 mb-8 flex items-center gap-2 self-start hover:text-slate-800 transition-colors">
                â† è¿”å›ç³»ç»Ÿé¦–é¡µ
            </button>
            
            <div class="glass-card rounded-[2rem] p-8 space-y-6 text-center">
                <div>
                    <div class="inline-block px-3 py-1 rounded-full bg-cyan-50 text-cyan-600 text-[10px] font-bold tracking-widest mb-4">DATA INTEGRATION</div>
                    <h2 class="text-2xl font-bold text-slate-900">å¥åº·åŸºçº¿æ­£åœ¨æ¥å…¥</h2>
                </div>
                
                <div class="py-12 flex flex-col items-center justify-center border-y border-slate-100">
                    <div class="w-12 h-12 border-4 border-cyan-100 border-t-cyan-500 rounded-full animate-spin mb-4"></div>
                    <p class="text-xs text-slate-400">æ­£åœ¨åŒæ­¥ TICS äº‘ç«¯æ•°æ®èŠ‚ç‚¹...</p>
                </div>

                <p class="text-xs text-slate-500 leading-relaxed">
                    AirBaseline æ•°å­—åŒ–ç®¡ç†ç³»ç»Ÿæ­£åœ¨è¿›è¡Œé¦–æ‰¹æ•°æ®åŒæ­¥ã€‚åœ¨è¯¥åŠŸèƒ½æ­£å¼ä¸Šçº¿åï¼Œæ‚¨å°†èƒ½å¤ŸæŸ¥çœ‹ç©ºé—´çš„åŠ¨æ€å¥åº·åŸºçº¿ã€‚
                </p>
                
                <button onclick="showPage('home-page')" class="w-full btn-primary py-4 rounded-xl text-[10px] font-bold tracking-widest uppercase text-white shadow-lg">
                    ç¡®å®š
                </button>
            </div>
        </div>
    </div>

    <!-- æ‰«ç æ¨¡æ€æ¡† -->
    <div id="scannerModal">
        <div id="reader"></div>
        <button onclick="closeScanner()" class="mt-8 bg-white/10 text-white px-8 py-3 rounded-full text-xs font-bold backdrop-blur-md border border-white/20">å…³é—­æ‰«æ</button>
    </div>

    <script>
        // ======================== é…ç½®åŒº =========================
        // è¯·åœ¨æ­¤å¤„å¡«å…¥çœŸå®çš„ Supabase URL å’Œ Key
        const SUPABASE_URL = 'https://evksoxqnxyvtxvzmuufy.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV2a3NveHFueHl2dHh2em11dWZ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxMjYwMjEsImV4cCI6MjA3OTcwMjAyMX0.R-n669k8gqOl5US1rFk7vJdqgAcRm_SBWvJPovMdcAU';
        // ======================================================

        let supabaseClient = null;
        let currentProductCode = null;
        let html5QrcodeScanner = null;

        // åˆå§‹åŒ–å®¢æˆ·ç«¯çš„å®‰å…¨å‡½æ•°
        function getSupabaseClient() {
            if (supabaseClient) return supabaseClient;
            if (!SUPABASE_URL || SUPABASE_URL === 'è¯·æ›¿æ¢' || !SUPABASE_URL.startsWith('http')) {
                displayMessage("é…ç½®é”™è¯¯ï¼šè¯·åœ¨ä»£ç é¡¶éƒ¨çš„é…ç½®åŒºè®¾ç½®æœ‰æ•ˆçš„ SUPABASE_URL");
                throw new Error("Invalid Supabase Config");
            }
            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            return supabaseClient;
        }

        // é¡µé¢åˆ‡æ¢
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const target = document.getElementById(pageId);
            target.classList.add('active');
            window.scrollTo(0, 0);
        }

        // æ¶ˆæ¯æç¤º
        function displayMessage(msg, type = 'error') {
            const box = document.getElementById('messageBox');
            box.innerText = msg;
            box.className = `w-full p-4 rounded-2xl text-center text-xs font-bold mb-4 transition-all duration-300 ${type === 'error' ? 'bg-red-50 text-red-500 border border-red-100' : 'bg-emerald-50 text-emerald-600 border border-emerald-100'}`;
            box.classList.remove('hidden');
            setTimeout(() => box.classList.add('hidden'), 5000);
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(ts) {
            if (!ts) return '---';
            const d = new Date(ts);
            return d.toLocaleDateString('zh-CN') + ' ' + d.getHours().toString().padStart(2,'0') + ':' + d.getMinutes().toString().padStart(2,'0');
        }

        // è§£æç»“æ„åŒ–å­—ç¬¦ä¸²
        function parseClientInfo(str) {
            const res = { name: '---', phone: '---', addr: '---', area: '---' };
            if (!str) return res;
            str.split(' | ').forEach(p => {
                const parts = p.split(': ');
                if (parts.length < 2) return;
                const [l, v] = parts;
                if (l.includes('å§“å')) res.name = v;
                else if (l.includes('ç”µè¯')) res.phone = v;
                else if (l.includes('åœ°å€')) res.addr = v;
                else if (l.includes('éƒ¨ä½')) res.area = v;
            });
            return res;
        }

        // æŸ¥è¯¢é€»è¾‘
        async function queryData() {
            const input = document.getElementById('productCode');
            let code = input.value.trim().toUpperCase();
            
            if (!code) return displayMessage("è¯·è¾“å…¥äº§å“ç¼–ç ");
            
            // æ™ºèƒ½è¡¥å…¨ TI- å‰ç¼€
            if (!code.startsWith('TI-') && code.length >= 4) {
                code = 'TI-' + code;
                input.value = code;
            }
            
            currentProductCode = code;
            
            // UI é”å®š
            const btns = document.querySelectorAll('.action-btn');
            btns.forEach(b => b.disabled = true);
            
            try {
                const client = getSupabaseClient();
                const { data, error } = await client.from('products').select('*').eq('code', code).single();
                
                btns.forEach(b => b.disabled = false);

                if (error || !data) {
                    document.getElementById('resultArea').classList.add('hidden');
                    return displayMessage("æŸ¥æ— æ­¤ç ï¼Œè¯·æ ¸å¯¹æ­£å“æ ‡è¯†æˆ–è¾“å…¥å®Œæ•´ç¼–ç ");
                }

                // å¡«å……ä¿¡æ¯
                document.getElementById('pCode').innerText = data.code;
                document.getElementById('pName').innerText = data.name;
                document.getElementById('pBatch').innerText = data.batch || 'æ ‡å‡†æ‰¹æ¬¡';
                
                const st = document.getElementById('pStatus');
                st.innerText = data.status === 'in_stock' ? 'å¾…æ–½å·¥' : 'å·²å®Œæˆ';
                st.className = `status-tag status-${data.status}`;
                
                document.getElementById('resultArea').classList.remove('hidden');

                // çŠ¶æ€é€»è¾‘
                if (data.status === 'in_stock') {
                    document.getElementById('serviceFormArea').classList.remove('hidden');
                    document.getElementById('serviceLogDisplay').classList.add('hidden');
                } else {
                    document.getElementById('serviceFormArea').classList.add('hidden');
                    document.getElementById('serviceLogDisplay').classList.remove('hidden');
                    fetchLog(code);
                }
            } catch (e) {
                btns.forEach(b => b.disabled = false);
                console.error(e);
            }
        }

        // è·å–å†å²è®°å½•
        async function fetchLog(code) {
            try {
                const client = getSupabaseClient();
                const { data, error } = await client.from('service_logs')
                    .select('*')
                    .eq('product_code_ref', code)
                    .order('created_at', {ascending:false})
                    .limit(1);

                if (data && data.length > 0) {
                    const log = data[0];
                    const info = parseClientInfo(log.client_info);
                    document.getElementById('logTechName').innerText = log.technician_name;
                    document.getElementById('logDate').innerText = formatTime(log.created_at);
                    document.getElementById('logClientName').innerText = info.name;
                    document.getElementById('logClientPhone').innerText = info.phone;
                    document.getElementById('logServiceAddress').innerText = info.addr;
                    document.getElementById('logServiceArea').innerText = info.area;
                } else {
                    // å¦‚æœçŠ¶æ€å·²æ›´æ–°ä½†æŸ¥ä¸åˆ°è®°å½• (å¯èƒ½ç”±äºRLSå»¶è¿Ÿ)
                    document.getElementById('logTechName').innerText = "æ¡£æ¡ˆåŒæ­¥ä¸­...";
                }
            } catch (e) {
                console.error("Fetch Log Error:", e);
            }
        }

        // ç™»è®°é€»è¾‘
        async function registerService() {
            const fields = {
                techName: 'techName',
                clientName: 'clientName',
                clientPhone: 'clientPhone',
                serviceAddress: 'serviceAddress',
                serviceArea: 'serviceArea'
            };
            
            const vals = {};
            for(let key in fields) {
                const el = document.getElementById(fields[key]);
                vals[key] = el.value.trim();
                if(!vals[key]) {
                    el.focus();
                    return displayMessage("è¯·å®Œæ•´å¡«å†™æ‰€æœ‰å¸¦ * çš„æ–½å·¥ä¿¡æ¯");
                }
            }

            const btn = document.getElementById('registerBtn');
            btn.disabled = true;
            btn.innerText = "æ­£åœ¨å®‰å…¨æäº¤...";

            try {
                const client = getSupabaseClient();
                const infoStr = `å®¢æˆ·å§“å: ${vals.clientName} | å®¢æˆ·ç”µè¯: ${vals.clientPhone} | æ–½å·¥åœ°å€: ${vals.serviceAddress} | æ–½å·¥éƒ¨ä½: ${vals.serviceArea}`;
                
                const { error } = await client.from('service_logs').insert([{
                    product_code_ref: currentProductCode,
                    technician_name: vals.techName,
                    client_info: infoStr
                }]);

                if (error) {
                    displayMessage("æäº¤å¤±è´¥: " + error.message);
                    btn.disabled = false;
                    btn.innerText = "ç¡®è®¤ç™»è®°å¹¶å®Œæˆ";
                } else {
                    displayMessage("æ¡£æ¡ˆå·²æˆåŠŸé”å®šï¼Œæ­£åœ¨åˆ·æ–°...", "success");
                    setTimeout(queryData, 800);
                }
            } catch (e) {
                btn.disabled = false;
                btn.innerText = "ç¡®è®¤ç™»è®°å¹¶å®Œæˆ";
                displayMessage("ç½‘ç»œå¼‚å¸¸æˆ–é…ç½®é”™è¯¯ï¼Œè¯·é‡è¯•");
            }
        }

        // æ‰«ç é€»è¾‘
        function startScanner() {
            document.getElementById('scannerModal').style.display = 'flex';
            if (!html5QrcodeScanner) html5QrcodeScanner = new Html5Qrcode("reader");
            html5QrcodeScanner.start(
                { facingMode: "environment" }, 
                { fps: 10, qrbox: 250 }, 
                (text) => {
                    document.getElementById('productCode').value = text.toUpperCase().trim();
                    closeScanner();
                    queryData();
                }
            ).catch(() => {
                displayMessage("æ— æ³•å¯åŠ¨æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥æƒé™æˆ–æ‰‹åŠ¨è¾“å…¥");
                closeScanner();
            });
        }

        function closeScanner() {
            if (html5QrcodeScanner && html5QrcodeScanner.isScanning) {
                html5QrcodeScanner.stop().then(() => {
                    document.getElementById('scannerModal').style.display = 'none';
                });
            } else {
                document.getElementById('scannerModal').style.display = 'none';
            }
        }

        // è‡ªåŠ¨æŸ¥è¯¢å…¥å£
        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            if(code) {
                document.getElementById('productCode').value = code.toUpperCase();
                // å°è¯•æŸ¥è¯¢ï¼Œå¦‚æœæœªé…ç½®Keyï¼Œä¼šè¢« getSupabaseClient æ•è·å¹¶æç¤º
                try { queryData(); } catch(e) {}
            }
        }
    </script>
</body>
</html>
