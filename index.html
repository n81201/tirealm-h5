<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TiRealmÂ® TICS - äº§å“æ¡£æ¡ˆåŠæœåŠ¡ç™»è®°</title>
    
    <!-- æ€§èƒ½ä¼˜åŒ–ï¼šDNS é¢„è§£æ -->
    <link rel="dns-prefetch" href="https://evksoxqnxyvtxvzmuufy.supabase.co">
    
    <!-- æ ¸å¿ƒåº“å¼•å…¥ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- æ‰«ç åº“éé¦–å±æ ¸å¿ƒï¼Œæ”¹ä¸ºå¼‚æ­¥åŠ è½½ -->
    <script src="https://unpkg.com/html5-qrcode" defer></script>
    
    <style>
        /* ä¼˜åŒ–æ–¹æ¡ˆï¼šç§»é™¤ Google Fonts @importã€‚
           ä½¿ç”¨ç³»ç»Ÿå­—ä½“æ ˆï¼šåœ¨ iOS ä¸Šè‡ªåŠ¨è°ƒç”¨è‹¹æ–¹/SF Proï¼Œå®‰å“ä¸Šè°ƒç”¨ Noto Sansï¼Œ
           è¿™æ˜¯ç›®å‰å…¼å®¹æ€§ã€ç¾è§‚åº¦ä¸åŠ è½½é€Ÿåº¦çš„æœ€ä½³å¹³è¡¡ç‚¹ã€‚
        */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
            background-color: #f8fafc;
            background-image: 
                radial-gradient(at 0% 0%, rgba(6, 182, 212, 0.05) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(30, 41, 59, 0.05) 0px, transparent 50%);
            color: #1e293b;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            overscroll-behavior-y: contain; /* é˜²æ­¢ç§»åŠ¨ç«¯ä¸‹æ‹‰åˆ·æ–° */
        }

        .app-viewport {
            width: 100%;
            max-width: 460px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 0 20px;
        }

        /* R æ ‡å¾®è°ƒï¼šæç»†ã€åŠé€æ˜ã€ä¸Šæµ® */
        .brand-r {
            font-size: 0.45em;
            vertical-align: super;
            margin-left: 2px;
            font-weight: 300;
            opacity: 0.6;
            display: inline-block;
            transform: translateY(-4px);
        }

        .tech-card-light {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 1);
            box-shadow: 0 10px 25px -5px rgba(15, 23, 42, 0.04);
            width: 100%;
            border-radius: 1.75rem;
        }

        .tech-card-dark {
            background: linear-gradient(145deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid rgba(255, 255, 255, 0.05);
            width: 100%;
            border-radius: 1.75rem;
            position: relative;
            overflow: hidden;
        }

        .input-tech {
            /* ç§»é™¤å¤–éƒ¨ä»£ç å­—ä½“ï¼Œä½¿ç”¨ç³»ç»Ÿç­‰å®½å­—ä½“ */
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            background: #ffffff;
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
            appearance: none; /* æ¸…é™¤iOSé»˜è®¤é˜´å½± */
        }
        .input-tech:focus {
            border-color: #06b6d4;
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
            outline: none;
        }

        .btn-primary {
            background: #0f172a;
            color: white;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            touch-action: manipulation;
        }
        .btn-primary:active { transform: scale(0.97); }

        .btn-accent {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(6, 182, 212, 0.2);
            touch-action: manipulation;
        }

        .status-badge {
            font-size: 10px;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 6px;
            text-transform: uppercase;
        }
        .status-in_stock { background: #ecfdf5; color: #059669; border: 1px solid #a7f3d0; }
        .status-serviced { background: #eff6ff; color: #2563eb; border: 1px solid #bfdbfe; }

        #scannerModal {
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(10px);
        }

        /* ç®€å•åŠ è½½åŠ¨ç”» */
        .loading-dot {
            display: inline-block;
            width: 4px;
            height: 4px;
            background: currentColor;
            border-radius: 50%;
            margin-left: 2px;
            animation: blink 1s infinite;
        }
        @keyframes blink { 0%, 100% { opacity: 0.2; } 50% { opacity: 1; } }
    </style>
</head>
<body>

    <div class="app-viewport">
        <!-- Header -->
        <header class="w-full pt-10 pb-6 text-center">
            <div class="inline-flex items-center justify-center px-3 py-1 mb-4 rounded-full bg-white/60 border border-slate-200 backdrop-blur-sm">
                <div class="w-1.5 h-1.5 rounded-full bg-cyan-500 mr-2 animate-pulse"></div>
                <span class="text-[9px] tracking-[0.25em] font-bold text-slate-500 uppercase">TICS System</span>
            </div>
            <h1 class="text-4xl font-black tracking-tight text-slate-900">
                TiRealm<span class="brand-r text-cyan-600">Â®</span>
            </h1>
            <p class="text-[10px] text-slate-400 mt-2 tracking-[0.4em] uppercase font-bold pl-[0.4em]">Digital Air Management</p>
        </header>

        <main class="w-full space-y-5 pb-10">
            <div id="messageBox" class="hidden w-full p-3 rounded-xl text-center text-xs font-bold mb-2 transition-all"></div>

            <!-- 1. äº§å“æ¡£æ¡ˆæŸ¥è¯¢ -->
            <section class="tech-card-light p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-sm font-bold text-slate-800 flex items-center gap-2">
                        <svg class="w-4 h-4 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                        äº§å“æ¡£æ¡ˆæŸ¥è¯¢
                    </h2>
                    <span class="text-[10px] text-slate-400 font-mono tracking-tighter">NODE_V1.5_OPT</span>
                </div>

                <div class="space-y-4">
                    <input type="text" id="productCode" placeholder="TI-XXXXXX" 
                           class="input-tech w-full rounded-2xl py-4 px-4 text-center text-xl font-bold tracking-[0.15em] text-slate-800 placeholder:text-slate-200 placeholder:tracking-normal placeholder:font-sans">
                    
                    <div class="flex gap-3">
                        <button id="queryBtn" onclick="queryData()" class="btn-primary flex-[2] py-4 rounded-2xl font-bold text-xs tracking-widest uppercase action-btn">
                            æŸ¥è¯¢è®°å½•
                        </button>
                        <button onclick="startScanner()" class="bg-white border border-slate-200 w-16 py-4 rounded-2xl flex items-center justify-center action-btn">
                            <svg class="w-6 h-6 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" stroke-width="2"/><circle cx="12" cy="13" r="3" stroke-width="2"/></svg>
                        </button>
                    </div>
                </div>
            </section>

            <!-- 2. æŸ¥è¯¢ç»“æœ -->
            <section id="resultArea" class="hidden tech-card-light p-6">
                <div class="flex items-center justify-between mb-5 pb-4 border-b border-slate-100">
                    <span class="text-[10px] font-bold tracking-widest text-slate-400 uppercase">Archive Details</span>
                    <div id="pStatusContainer">
                        <span id="pStatus" class="status-badge">---</span>
                    </div>
                </div>

                <div class="space-y-3 mb-6">
                    <div class="flex justify-between items-center">
                        <span class="text-[11px] text-slate-400">ç¼–ç </span>
                        <span id="pCode" class="text-xs font-mono font-bold text-slate-700 bg-slate-50 px-2 py-1 rounded">---</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-[11px] text-slate-400">åç§°</span>
                        <span id="pName" class="text-xs font-bold text-slate-700">---</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-[11px] text-slate-400">æ‰¹æ¬¡</span>
                        <span id="pBatch" class="text-xs font-bold text-slate-700">---</span>
                    </div>
                </div>

                <div id="serviceFormArea" class="hidden">
                    <div class="bg-slate-50 rounded-xl p-4 border border-slate-100 mb-4">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                            <h3 class="text-xs font-bold text-slate-700">ç™»è®°æ–½å·¥ä¿¡æ¯</h3>
                        </div>
                        <div class="space-y-2.5">
                            <input type="text" id="techName" placeholder="æ–½å·¥å•ä½/æŠ€å¸ˆ *" class="input-tech w-full rounded-lg py-2.5 px-3 text-xs">
                            <input type="text" id="clientName" placeholder="å®¢æˆ·å§“å *" class="input-tech w-full rounded-lg py-2.5 px-3 text-xs">
                            <input type="text" id="clientPhone" placeholder="å®¢æˆ·ç”µè¯ *" class="input-tech w-full rounded-lg py-2.5 px-3 text-xs">
                            <input type="text" id="serviceAddress" placeholder="æ–½å·¥åœ°å€ *" class="input-tech w-full rounded-lg py-2.5 px-3 text-xs">
                            <input type="text" id="serviceArea" placeholder="æ–½å·¥éƒ¨ä½ *" class="input-tech w-full rounded-lg py-2.5 px-3 text-xs">
                        </div>
                    </div>
                    <button id="registerBtn" onclick="registerService()" class="w-full btn-accent py-4 rounded-xl font-bold text-xs tracking-widest uppercase">
                        ç¡®è®¤å¹¶é”å®šæ¡£æ¡ˆ
                    </button>
                </div>

                <div id="serviceLogDisplay" class="hidden">
                    <div class="bg-slate-900 rounded-2xl p-5 text-white space-y-3">
                        <div class="flex justify-between items-center border-b border-white/10 pb-2">
                            <span class="text-[10px] text-slate-500">æ–½å·¥å•ä½</span>
                            <span id="logTechName" class="text-xs font-bold text-cyan-400">---</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-[10px] text-slate-500">å®Œæˆæ—¶é—´</span>
                            <span id="logDate" class="text-xs font-bold font-mono">---</span>
                        </div>
                        <div class="grid grid-cols-2 gap-y-3 gap-x-4 pt-2">
                            <div>
                                <div class="text-[9px] text-slate-500 mb-0.5">å®¢æˆ·</div>
                                <div id="logClientName" class="text-xs font-bold">---</div>
                            </div>
                            <div>
                                <div class="text-[9px] text-slate-500 mb-0.5">ç”µè¯</div>
                                <div id="logClientPhone" class="text-xs font-bold font-mono">---</div>
                            </div>
                            <div class="col-span-2">
                                <div class="text-[9px] text-slate-500 mb-0.5">æ–½å·¥åœ°å€</div>
                                <div id="logServiceAddress" class="text-xs font-medium text-slate-300">---</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 3. AirBaseline -->
            <section class="tech-card-dark p-7 group cursor-pointer" onclick="showPage('baseline-page')">
                <div class="absolute -right-10 -top-10 w-40 h-40 bg-cyan-500/10 rounded-full blur-[50px] group-hover:bg-cyan-500/20 transition-all duration-700"></div>
                <div class="relative z-10">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <div class="w-1.5 h-1.5 rounded-full bg-cyan-400 shadow-[0_0_8px_rgba(34,211,238,0.8)]"></div>
                            <span class="text-[10px] font-bold tracking-[0.2em] text-cyan-400 uppercase">AirBaseline</span>
                        </div>
                    </div>
                    <h3 class="text-xl font-bold text-white mb-2">ç©ºæ°”å¥åº·åŸºçº¿æ¡£æ¡ˆ</h3>
                    <p class="text-[11px] text-slate-400 leading-relaxed font-light mb-6">å…¨ç”Ÿå‘½å‘¨æœŸæ•°æ®æ‰˜ç®¡ï¼Œæ•°å­—åŒ–è¿½æº¯ç©ºæ°”å˜åŠ¨ã€‚</p>
                    <div class="flex items-center gap-2 text-[10px] font-bold text-cyan-400">
                        <span>è¿›å…¥ç³»ç»Ÿ</span>
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7" stroke-width="3"/></svg>
                    </div>
                </div>
            </section>

            <footer class="text-center py-8">
                <p class="text-[9px] text-slate-400 tracking-[0.3em] font-bold uppercase opacity-60">TiRealmÂ® TICS Ecosystem</p>
            </footer>
        </main>
    </div>

    <!-- æ‰«ç æ¨¡æ€æ¡† -->
    <div id="scannerModal" class="hidden fixed inset-0 z-[100] flex-col items-center justify-center bg-slate-900/95 p-6">
        <div class="w-full max-w-sm border-2 border-cyan-500 rounded-2xl overflow-hidden shadow-[0_0_50px_rgba(6,182,212,0.3)]">
            <div id="reader"></div>
        </div>
        <button onclick="closeScanner()" class="mt-8 bg-white/10 border border-white/20 text-white px-10 py-3 rounded-full text-xs font-bold">å–æ¶ˆ</button>
    </div>

    <!-- åŸºçº¿é¡µ -->
    <div id="baseline-page" class="fixed inset-0 z-50 bg-[#f1f5f9] hidden flex-col items-center overflow-y-auto">
        <div class="w-full max-w-[460px] px-6 py-12 flex flex-col items-center">
            <div class="tech-card-light p-10 text-center">
                <div class="text-4xl mb-6">ğŸ“¡</div>
                <h2 class="text-xl font-bold mb-2">åŸºçº¿åŒæ­¥ä¸­</h2>
                <p class="text-xs text-slate-500 leading-relaxed mb-8">AirBaseline æ•°å­—åŒ–ç®¡ç†ç³»ç»Ÿæ­£åœ¨åŒæ­¥é¦–æ‰¹ç©ºæ°”å¥åº·èŠ‚ç‚¹æ•°æ®ã€‚</p>
                <button onclick="showPage('home-page')" class="w-full btn-primary py-4 rounded-xl text-xs font-bold uppercase">è¿”å›</button>
            </div>
        </div>
    </div>

    <script>
        // ======================== æ ¸å¿ƒé€»è¾‘ =========================
        const SUPABASE_URL = 'https://evksoxqnxyvtxvzmuufy.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV2a3NveHFueHl2dHh2em11dWZ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxMjYwMjEsImV4cCI6MjA3OTcwMjAyMX0.R-n669k8gqOl5US1rFk7vJdqgAcRm_SBWvJPovMdcAU';

        let supabaseClient = null;
        let currentProductCode = null;
        let html5QrcodeScanner = null;

        function getSupabaseClient() {
            if (supabaseClient) return supabaseClient;
            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            return supabaseClient;
        }

        function displayMessage(msg, type = 'error') {
            const box = document.getElementById('messageBox');
            box.innerText = msg;
            box.className = `w-full p-3 rounded-xl text-center text-xs font-bold mb-4 transition-all border ${type === 'error' ? 'bg-red-50 text-red-500 border-red-100' : 'bg-emerald-50 text-emerald-600 border-emerald-100'}`;
            box.classList.remove('hidden');
            setTimeout(() => box.classList.add('hidden'), 4000);
        }

        function formatTime(ts) {
            if (!ts) return '---';
            const d = new Date(ts);
            return `${d.getFullYear()}.${(d.getMonth()+1).toString().padStart(2,'0')}.${d.getDate().toString().padStart(2,'0')} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
        }

        function parseClientInfo(str) {
            const res = { name: '---', phone: '---', addr: '---', area: '---' };
            if (!str) return res;
            str.split(' | ').forEach(p => {
                const parts = p.split(': ');
                if (parts.length < 2) return;
                const [l, v] = parts;
                if (l.includes('å§“å')) res.name = v;
                else if (l.includes('ç”µè¯')) res.phone = v;
                else if (l.includes('åœ°å€')) res.addr = v;
                else if (l.includes('éƒ¨ä½')) res.area = v;
            });
            return res;
        }

        async function queryData() {
            const input = document.getElementById('productCode');
            const queryBtn = document.getElementById('queryBtn');
            let code = input.value.trim().toUpperCase();
            
            if (!code) return displayMessage("è¯·è¾“å…¥äº§å“ç¼–ç ");
            if (!code.startsWith('TI-') && code.length >= 4) {
                code = 'TI-' + code;
                input.value = code;
            }
            
            currentProductCode = code;
            
            // æŒ‰é’® Loading çŠ¶æ€ä¼˜åŒ–
            const originalText = queryBtn.innerText;
            queryBtn.disabled = true;
            queryBtn.innerHTML = `æŸ¥è¯¢ä¸­<span class="loading-dot"></span>`;

            try {
                const client = getSupabaseClient();
                const { data, error } = await client.from('products').select('*').eq('code', code).single();
                
                queryBtn.disabled = false;
                queryBtn.innerText = originalText;

                if (error || !data) {
                    document.getElementById('resultArea').classList.add('hidden');
                    return displayMessage("æŸ¥æ— æ­¤ç ï¼Œè¯·æ ¸å¯¹æ­£å“æ ‡è¯†");
                }

                document.getElementById('pCode').innerText = data.code;
                document.getElementById('pName').innerText = data.name;
                document.getElementById('pBatch').innerText = data.batch || 'æ ‡å‡†æ‰¹æ¬¡';
                
                const st = document.getElementById('pStatus');
                st.innerText = data.status === 'in_stock' ? 'å¾…æ–½å·¥' : 'å·²å®Œæˆ';
                st.className = `status-badge ${data.status === 'in_stock' ? 'status-in_stock' : 'status-serviced'}`;
                
                document.getElementById('resultArea').classList.remove('hidden');
                
                if (data.status === 'in_stock') {
                    document.getElementById('serviceFormArea').classList.remove('hidden');
                    document.getElementById('serviceLogDisplay').classList.add('hidden');
                } else {
                    document.getElementById('serviceFormArea').classList.add('hidden');
                    document.getElementById('serviceLogDisplay').classList.remove('hidden');
                    fetchLog(code);
                }
                
                // æ»šåŠ¨åˆ°ç»“æœåŒº
                document.getElementById('resultArea').scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            } catch (e) {
                queryBtn.disabled = false;
                queryBtn.innerText = originalText;
                displayMessage("è¿æ¥å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ");
            }
        }

        async function fetchLog(code) {
            try {
                const client = getSupabaseClient();
                const { data } = await client.from('service_logs').select('*').eq('product_code_ref', code).order('created_at', {ascending:false}).limit(1);
                if (data && data.length > 0) {
                    const log = data[0];
                    const info = parseClientInfo(log.client_info);
                    document.getElementById('logTechName').innerText = log.technician_name;
                    document.getElementById('logDate').innerText = formatTime(log.created_at);
                    document.getElementById('logClientName').innerText = info.name;
                    document.getElementById('logClientPhone').innerText = info.phone;
                    document.getElementById('logServiceAddress').innerText = info.addr;
                }
            } catch (e) { console.error(e); }
        }

        async function registerService() {
            const fields = ['techName', 'clientName', 'clientPhone', 'serviceAddress', 'serviceArea'];
            const vals = {};
            for(let f of fields) {
                vals[f] = document.getElementById(f).value.trim();
                if(!vals[f]) return displayMessage("è¯·å®Œæ•´å¡«å†™æ‰€æœ‰å¸¦ * çš„ä¿¡æ¯");
            }
            const btn = document.getElementById('registerBtn');
            btn.disabled = true;
            btn.innerHTML = `æäº¤ä¸­<span class="loading-dot"></span>`;
            
            try {
                const client = getSupabaseClient();
                const infoStr = `å§“å: ${vals.clientName} | ç”µè¯: ${vals.clientPhone} | åœ°å€: ${vals.serviceAddress} | éƒ¨ä½: ${vals.serviceArea}`;
                const { error } = await client.from('service_logs').insert([{
                    product_code_ref: currentProductCode,
                    technician_name: vals.techName,
                    client_info: infoStr
                }]);
                if (error) throw error;
                displayMessage("ç™»è®°æˆåŠŸï¼", "success");
                setTimeout(queryData, 800);
            } catch (e) {
                btn.disabled = false;
                btn.innerText = "ç¡®è®¤å¹¶é”å®šæ¡£æ¡ˆ";
                displayMessage("æäº¤å¤±è´¥: " + e.message);
            }
        }

        function startScanner() {
            document.getElementById('scannerModal').style.display = 'flex';
            if (!html5QrcodeScanner) {
                html5QrcodeScanner = new Html5Qrcode("reader");
            }
            html5QrcodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (text) => {
                document.getElementById('productCode').value = text.toUpperCase().trim();
                closeScanner();
                queryData();
            }).catch(() => {
                displayMessage("æ‘„åƒå¤´å¼€å¯å¤±è´¥");
                closeScanner();
            });
        }

        function closeScanner() {
            if (html5QrcodeScanner && html5QrcodeScanner.isScanning) {
                html5QrcodeScanner.stop().then(() => document.getElementById('scannerModal').style.display = 'none');
            } else {
                document.getElementById('scannerModal').style.display = 'none';
            }
        }

        function showPage(pageId) {
            if (pageId === 'baseline-page') {
                document.getElementById('baseline-page').classList.replace('hidden', 'flex');
            } else {
                document.getElementById('baseline-page').classList.replace('flex', 'hidden');
            }
        }

        window.onload = () => {
            const code = new URLSearchParams(window.location.search).get('code');
            if(code) {
                document.getElementById('productCode').value = code.toUpperCase();
                try { queryData(); } catch(e) {}
            }
        }
    </script>
</body>
</html>
